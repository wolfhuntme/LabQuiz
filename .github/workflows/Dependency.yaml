name: Dependency Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  dependency-check:
    name: Check PHP Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        
    - name: Create minimal composer.json
      run: |
        cat > composer.json << 'EOF'
        {
          "name": "secure-webapp/search-app",
          "description": "Simple search application",
          "require": {
            "php": ">=8.1"
          },
          "require-dev": {
            "roave/security-advisories": "dev-latest"
          }
        }
        EOF
        
    - name: Install Composer
      run: |
        curl -sS https://getcomposer.org/installer | php
        mv composer.phar /usr/local/bin/composer
        
    - name: Check for security vulnerabilities
      run: |
        echo "üîç Checking for known security vulnerabilities..."
        composer install --no-scripts --no-progress 2>&1 | tee install.log || true
        
        if grep -q "conflicts" install.log || grep -q "roave/security-advisories" install.log; then
          echo "‚ö†Ô∏è Security vulnerabilities found!"
          echo "Please review the warnings above for details."
        else
          echo "‚úÖ No known security vulnerabilities found"
        fi
        
    - name: Check PHP version compatibility
      run: |
        echo "üîç Checking PHP compatibility..."
        php -v
        php -m | grep -E "(mysqli|pdo)" || echo "‚ö†Ô∏è Database extensions not found"
        
    - name: Summary
      if: always()
      run: |
        echo "üìä Dependency Check Summary:"
        echo "- PHP Version: $(php -v | head -n 1)"
        echo "- Composer Version: $(composer --version)"
        echo "‚úÖ Dependency check completed"